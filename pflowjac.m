function [dSdd , dSdv] = pflowjac(Y,vbus)%%  This routine forms the matrix of partial derivatives%  of COMPLEX power absorbed by the network at each bus, with%  respect to bus voltage angles and voltage magnitudes.%  %  Arguments: complex bus admittance matrix, Y;%             vector of complex bus voltage phasors, vbus.%%  Returns:   Two full, complex nxn matrices of partial derivatives;%             dSdd = partial of complex power w.r.t. delta;%             dSdv = partial of complex power w.r.t. voltage magnitude.%  Comments:  Note that we return ALL the partial derivatives%             of power absorbed at EVERY bus with respect to%             EVERY voltage magnitude and phase angle.%             Slack, P-V, and P-Q bus models are not%             imposed at this point; this allows switching%             between P-V and P-Q models at generators with%             reactive power limits.%%  Interpretation:  The operation of this routine is%  transparent if one recognizes the following %  equivalences:%     S = diag(vbus)*conj(ibus) = diag(conj(ibus))*vbus;%  hence:%    dS/d(delta) = diag(vbus)*conj(d(ibus)/d(delta))%                + diag(conj(ibus))*d(vbus)/d(delta)%%  Similarly:%    dS/d(vmag) = diag(vbus)*conj(d(ibus)/d(vmag))%                + diag(conj(ibus))*d(vbus)/d(vmag)%%j=sqrt(-1);%ibus=Y*vbus;dSdd =j*diag(conj(ibus).*vbus) ...          -j*diag(vbus)*conj(Y)*diag(conj(vbus));%dSdv = diag(conj(ibus).*(vbus./abs(vbus)))+ ...          diag(vbus)*conj(Y)*diag(conj(vbus)./abs(vbus));